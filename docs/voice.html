<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimal-ui" />
		<link rel="stylesheet" href="build/conversational-form-docs.min.css">

		<!--<script type="text/javascript" src="https://cf-4053.kxcdn.com/conversational-form/0.9.4/conversational-form.min.js" crossorigin></script>-->
	</head>
	<body>
		<script src="build/conversational-form-examples.min.js" id="examples-script"></script>

	<body>

		<style>
			.form-outer{
				background: lightgrey;
				width: 100%;
				height: 100vh;
			}
			#conversational-form{
				width: 50vw;
				left: auto;
				right: 0px;
			}
		</style>


		<main class="content">
			<menu id="small-screen-menu">
				<h2>Conversational Form examples</h2>

				<div class="switch-btn">
					<label class="switch">
						<input type="checkbox" onclick="window.conversationalFormExamples.toggleConversation(event)">
						<div class="slider round"></div>
					</label>
				</div>

				<div class="hamburger-btn" onclick="window.conversationalFormExamples.toggleMenuState(event)">
					<svg viewBox="0 0 29 14" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
						<g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" stroke-linecap="square">
							<g transform="translate(-325.000000, -87.000000)" stroke="#FFFFFF" stroke-width="2">
								<g transform="translate(325.000000, 87.000000)">
									<path d="M27.4802431,7 L1.23827993,7"></path>
									<path d="M27.4802431,1 L1.23827993,1"></path>
									<path d="M27.4802431,13 L1.23827993,13"></path>
								</g>
							</g>
						</g>
					</svg>
				</div>
			</menu>

			<div class="switch-btn" id="cf-toggle-btn" data-label="Enable Conversational Form" data-label-toggled="Disable Conversational Form">
				<label class="switch">
					<input type="checkbox" onclick="window.conversationalFormExamples.toggleConversation(event)">
					<div class="slider round"></div>
				</label>
			</div>

			<section id="info" role="info">
				<div class="close-btn" onclick="window.conversationalFormExamples.toggleMenuState()">
					<svg viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
						<g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" stroke-linecap="square">
							<g transform="translate(-328.000000, -83.000000)" stroke="#FFFFFF" stroke-width="2">
								<g id="close" transform="translate(329.000000, 84.000000)">
									<path d="M19.6371966,19.2779351 L1.08132646,0.722064927"></path>
									<path d="M19.4923318,0.722064927 L0.936461672,19.2779351"></path>
								</g>
							</g>
						</g>
					</svg>
				</div>

				<article>
					<h1 id="writer">
						Voice control
					</h1>
					<h2>
						Custom User Input Interface, using <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Speech_API" target="_blank">Web Speech API</a> we allow a user to use speech as their input control, we also tab into <a href="" target="_blank">Conversational Form events</a> and read out loud the robot responses.
					</h2>
				</article>
			</section>

			<section role="form">
				<div class="form-outer">

					<form id="form">

						<input
							id="123"
							name="123"
							type="text"
							cf-questions="Hello! Activate your microphone"
						/>

						<input
							id="456"
							name="456"
							type="text"
							cf-questions="Audio input 2 {123}"
						/>

					</form>

				</div>
			</section>

			<section id="cf-context" role="cf-context">
				<div class="form-outer" cf-context>
					
				</div>
			</section>
		</main>






















		<script
			type="text/javascript"
			src="../build/bower_components/promise-polyfill/promise.js"
		></script>

		<script
			type="text/javascript"
			src="../build/bower_components/custom-event-polyfill/custom-event-polyfill.js"
		></script>

		<script
			id="conversational-form-development" 
			type="text/javascript"
			src="../build/cf/ConversationalForm.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/parsing/TagsParser.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/ConversationalForm.plugin.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/logic/Helpers.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/logic/EventDispatcher.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/ui/BasicElement.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/ui/control-elements/ControlElement.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/ui/control-elements/ControlElements.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/ui/ScrollController.js"
		></script>

		<script 
			type="text/javascript"
			src="../build/cf/data/Dictionary.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/form-tags/Tag.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/form-tags/TagGroup.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/form-tags/InputTag.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/form-tags/SelectTag.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/form-tags/ButtonTag.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/form-tags/OptionTag.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/ui/control-elements/Button.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/ui/control-elements/RadioButton.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/ui/control-elements/CheckboxButton.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/ui/control-elements/OptionButton.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/ui/control-elements/OptionsList.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/ui/control-elements/UploadFileUI.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/interfaces/IUserInput.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/interfaces/IUserInputElement.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/ui/inputs/UserInputElement.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/ui/inputs/UserTextInput.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/ui/inputs/UserVoiceInput.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/ui/chat/ChatResponse.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/ui/chat/ChatList.js"
		></script>

		<script
			type="text/javascript"
			src="../build/cf/logic/FlowManager.js"
		></script>

		<link type="text/css" rel="stylesheet" href="../build/cf/cf.css"/>
		<link type="text/css" rel="stylesheet" href="../build/cf/ui/control-elements/cf-control-elements.css"/>
		<link type="text/css" rel="stylesheet" href="../build/cf/ui/control-elements/cf-button.css"/>
		<link type="text/css" rel="stylesheet" href="../build/cf/ui/control-elements/cf-radio-button.css"/>
		<link type="text/css" rel="stylesheet" href="../build/cf/ui/control-elements/cf-checkbox-button.css"/>
		<link type="text/css" rel="stylesheet" href="../build/cf/ui/control-elements/cf-options-list.css"/>
		<link type="text/css" rel="stylesheet" href="../build/cf/ui/control-elements/cf-upload-file-ui.css"/>
		<link type="text/css" rel="stylesheet" href="../build/cf/ui/cf-input.css"/>
		<link type="text/css" rel="stylesheet" href="../build/cf/ui/cf-info.css"/>
		<link type="text/css" rel="stylesheet" href="../build/cf/ui/cf-list-button.css"/>
		<link type="text/css" rel="stylesheet" href="../build/cf/ui/chat/cf-chat-response.css"/>
		<link type="text/css" rel="stylesheet" href="../build/cf/ui/chat/cf-chat.css"/>

		<!-- OR -->
		<!--<script type="text/javascript" id="conversational-form-development" src="../dist/conversational-form.min.js" crossorigin></script>-->

		
		<script>

			(function(){
			})();

			function initExample(){
				var dispatcher = new cf.EventDispatcher(),
					synth = null,
					msg = null;

				// custom input using Web Speech API
				var microphoneInput = {
					// behaviors needs to follow interfaces, they will be checked!
					type: cf.UserInputTypes.VOICE,
					init: () => {
						// init is called when

						// load voices
						synth = window.speechSynthesis;
						msg = new SpeechSynthesisUtterance();
						window.speechSynthesis.onvoiceschanged = function(e) {
							var voices = synth.getVoices();
							msg.voice = voices[0]; // <-- Alex
							msg.lang = msg.voice.lang; // change language here
						};
						synth.getVoices();

						// setup event to speak robot response
						dispatcher.addEventListener(cf.ChatListEvents.CHATLIST_UPDATED, function(event){
							if(event.detail.currentResponse.isRobotResponse){
								// console.log("CHATLIST updated...", "...so speak it!", event.detail.currentResponse.response);
								// https://developer.mozilla.org/en-US/docs/Web/API/SpeechSynthesisUtterance
								msg.text = event.detail.currentResponse.response
								window.speechSynthesis.speak(msg);
							}
						}, false);
					},
					input: (resolve, reject) => {
						// connect to Speech API (ex. Google Cloud Speech) or use Web Speech API (like below), resolve with text..
						// using Promise pattern
							// if API fails use reject(result)
							// if API succedes use resolve(result)
						
						// https://developer.mozilla.org/en-US/docs/Web/API/Web_Speech_API
						var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition

						var recognition = new SpeechRecognition();
						recognition.continuous = false; // react only on single input
						recognition.interimResults = false; // we don't care about interim, only final.
						var finalTranscript = '';
						
						// recognition.onstart = function() {}
						recognition.onresult = function(event) {
							// var interimTranscript = "";
							for (var i = event.resultIndex; i < event.results.length; ++i) {
								if (event.results[i].isFinal) {
									finalTranscript += event.results[i][0].transcript;
								}/* else {
									interimTranscript += event.results[i][0].transcript;
								}*/
							}
						}
						recognition.onerror = function(event) {
							reject("error: " + event.error);
						}
						recognition.onend = function() {
							resolve(finalTranscript);
						}

						recognition.lang = msg.voice.lang;
						recognition.start();
					}
				}

				// start the conversation ->
				var conversationalForm = window.cf.ConversationalForm.startTheConversation({
					formEl: document.getElementById("form"),
					context: document.getElementById("context"),
					eventDispatcher: dispatcher,
					userInput: microphoneInput, // <--- custom user input
					flowStepCallback: function(dto, success, error){
						success();
					},
					submitCallback: function(){
						// remove Conversational Form
						alert("You made it!")
						console.log("Form submitted...");
					}
				});
			}
		</script>
	</body>
</html>
